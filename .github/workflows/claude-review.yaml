name: Claude Code

on:
  issues:
    types: [labeled, opened, assigned]
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: >-
      (github.event_name == 'issues' && github.event.label.name == 'claude') ||
      (github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.body, '/claude')) ||
      (github.event_name == 'issues' && github.event.action == 'assigned') ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '/claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '/claude'))

    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code
        id: claude
        uses: hjsad1994/claude-code-action@main
        with:
          custom_api_base_url: ${{ secrets.CUSTOM_API_BASE_URL }}
          custom_api_key: ${{ secrets.CUSTOM_API_KEY }}
          trigger_phrase: "/claude"
          additional_permissions: |
            actions: read
          track_progress: true
          prompt: |
            **IMPORTANT - WHEN WORKING ON ISSUES:**
            After you finish implementing the code changes and committing them, create a pull request:
            ```
            gh pr create --title "Your descriptive title" --body "## Summary
            Your summary of what was implemented.

            Closes #${{ github.event.issue.number }}"
            ```
            Always include a summary of changes AND "Closes #${{ github.event.issue.number }}" in the body.

            **COMMIT RULES:**
            - Do NOT add "Co-authored-by" lines to commits
            - Do NOT add "Generated with Claude Code" or similar attributions
            - Keep commits clean and professional

            **WHEN WORKING ON PR FEEDBACK:**
            Make the requested changes and commit. The PR will automatically update - do NOT create a new PR.

            **WHEN FIXING CI FAILURES:**
            Fix the issues, commit the fix. The CI will automatically re-run.

            **OUTPUT RULES:**

            ## Commit Message Requirements (max 72 chars)
            - Imperative mood: "Add" not "Added"
            - Action verbs: Add, Update, Fix, Remove, Refactor, Implement
            - No articles (a, an, the)
            - No punctuation at end
            - No prefixes like "feat:", "fix:"
            - Single line only
            - NO co-author attributions

          claude_args: |
            --model "gpt-5.2-codex"
            --max-turns 100
            --allowedTools "Bash(git:*),Bash(gh issue:*),Bash(gh pr:*),Bash(gh repo:*),Bash(npm:*),Bash(npx:*),Bash(bun:*),Bash(node:*),Bash(yarn:*),Edit,Write,Read,Glob,Grep,LS,WebSearch,WebFetch"

      - name: Clean up Claude comment
        if: github.event_name == 'issues'
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments --jq '.[-1].id')

          if [ -n "$COMMENT_ID" ]; then
            BODY=$(gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID --jq '.body')
            CLEANED=$(echo "$BODY" | sed 's/ • \[Create PR ➔\]([^)]*)//g' | sed 's/[[:space:]]*|[[:space:]]*$//')
            gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
              -X PATCH \
              -f body="$CLEANED"
          fi
